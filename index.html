<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Escalonador de Processos</title>
  <link rel="stylesheet" href="css.css">
</head>

<body>

  <h1 style="text-align: center">Escalonador de Processos</h1>

  <div id="formularios" class="content">
    <form>

      <p>Escolha o tipo de processamento:</p>
      <br>

      <p>Tipo de processamento:</p>

      <input type="radio" name="tipo_processamento" value="round_robin">
      <label for="round_robin">Round Robin (RR)</label>
      <br>
      <input type="radio" name="tipo_processamento" value="sjf">
      <label for="sfj">Shrtest-Job-First (SFJ)</label>
      <br>
      <input type="radio" name="tipo_processamento" value="prioridade">
      <label for="prioridade">Por prioridade (preemptiva)</label>
    </form>

    <form>
      <br>
      <p>Adicione um processo:</p>
      <br>
      <label>Duração (ciclos de máquina):</label>
      <br>
      <input type="text" id="duracao">
      <br>
      <br>
      <label>Prioridade (Quanto mais próximo de 0, maior a prioridade):</label>
      <br>
      <input type="text" id="prioridade">
      <br>
      <br>
      <input type="checkbox" id="ioBound">
      <label>I/O Bound</label>
      <br>
      <br>
    </form>

    <button type="button" onclick="adicionarProcesso()">Adicionar</button>
    <button type="button" onclick="processar()">Processar</button>

    <br>
  </div>


  <div id="div_processos" class="content"></div>

  <div id="resultado" class="content"></div>

  <script>
    let processos = [];
    let linhaDoTempo = [];

    function adicionarProcesso() {
      let processo = {
        nome: processos.length + 1,
        duracao: parseInt(document.getElementById("duracao").value) || 1,
        prioridade: parseInt(document.getElementById("prioridade").value) || 0,
        ioBound: document.getElementById("ioBound").checked
      }

      if (processo.ioBound) {
        processo.prioridade = 10;
        processo.duracao = 0;
      }

      processos.push(processo);

      console.log(processo)

      atualizarDivProcessos();
    }

    function ordenarPorDuracao(lista) {
      processos.sort((a, b) => a.duracao - b.duracao);
    }

    function ordenarPorPrioridade(lista) {
      lista.sort((a, b) => a.prioridade - b.prioridade);
    }

    function atualizarDivProcessos() {

      let divProcessos = document.getElementById("div_processos")

      let frag = document.createDocumentFragment()

      for (processo of processos) {
        let table = document.createElement("table")
        table.className = "processo"

        let th = document.createElement("th")
        th.innerHTML = "Processo"

        let nome = criarLinhaTabela("Nome", processo.nome)
        let duracao = criarLinhaTabela("Duração", processo.duracao)
        let prioridade = criarLinhaTabela("Prioridade", processo.prioridade)

        table.appendChild(th)
        table.appendChild(nome)
        table.appendChild(duracao)
        table.appendChild(prioridade)

        frag.appendChild(table)
      }

      divProcessos.innerHTML = ''
      divProcessos.appendChild(frag)

    }

    function criarLinhaTabela(nome, valor) {
      let frag = document.createDocumentFragment()

      let tr = document.createElement("tr")
      let td = document.createElement("td")

      td.innerHTML = `${nome}: ${valor}`

      tr.appendChild(td)
      frag.appendChild(tr)

      return frag
    }

    function criarTabelaLinhaDoTempo() {

      let tamanhoMaximoDivisao = 20

      let totalDivisoes = Math.floor((linhaDoTempo.length + 1) / tamanhoMaximoDivisao) + 1
      let divResultado = document.getElementById("resultado")

      divResultado.innerHTML = ''

      for (let divisaoAtual = 0; divisaoAtual < totalDivisoes; divisaoAtual++) {

        let frag = document.createDocumentFragment()

        let table = document.createElement("table")
        table.className = "linha_do_tempo"

        let tr_headerRow = document.createElement("tr")
        let th_titulo = document.createElement("th")
        th_titulo.innerHTML = 'Tempo de maquina:'
        tr_headerRow.appendChild(th_titulo)

        let tr_dataRow = document.createElement("tr")
        let td_titulo = document.createElement("td")
        td_titulo.innerHTML = 'Processo:'
        tr_dataRow.appendChild(td_titulo)

        for (let i = divisaoAtual * tamanhoMaximoDivisao; i < tamanhoMaximoDivisao * (divisaoAtual + 1) && i < linhaDoTempo.length; i++) {

          console.log(i)

          let th = document.createElement("th")
          th.innerHTML = i + 1
          tr_headerRow.appendChild(th)
        }

        for (let i = divisaoAtual * tamanhoMaximoDivisao; i < tamanhoMaximoDivisao * (divisaoAtual + 1) && i < linhaDoTempo.length; i++) {
          let td = document.createElement("td")
          td.innerHTML = linhaDoTempo[i].nome
          tr_dataRow.appendChild(td)
        }

        table.appendChild(tr_headerRow)
        table.appendChild(tr_dataRow)

        divResultado.appendChild(table)
        divResultado.append(document.createElement("br"))
      }
    }

    function processar() {
      let tipoProcessamento = document.querySelector('input[name="tipo_processamento"]:checked').value;
      let resultado = document.getElementById("resultado");

      linhaDoTempo = []

      if (tipoProcessamento === "round_robin") {
        resultado.innerHTML = roundRobin();
      } else if (tipoProcessamento === "sjf") {
        resultado.innerHTML = shortestJobFirst();
      } else if (tipoProcessamento === "prioridade") {
        resultado.innerHTML = prioridadePreemptiva();
      }

      criarTabelaLinhaDoTempo()
    }

    // Cada processo recebe uma quantidade fixa de tempo de CPU (quantum) e, se não for concluído nesse período, é colocado no final da fila para aguardar sua próxima vez
    function roundRobin() {
      const quantum = 2;

      let fila = [...processos];
      // Cada processo recebe uma quantidade fixa de tempo de CPU (quantum) e, se não for concluído nesse período, é colocado no final da fila para aguardar sua próxima vez

      // Loop que continua até que todos os processos sejam concluídos
      while (fila.length > 0) {
        //Remove o primeiro processo da fila
        let processo = fila.shift();

        for (i = 0; i < quantum && processo.duracao != 0; i++) {
          processo.duracao -= 1
          linhaDoTempo.push(processo)
        }


        if (processo.duracao > 0) fila.push(processo); // Adiciona de volta ao final da fila
      }
    }

    function shortestJobFirst() {

      let fila = [...processos];

      // Ordena os processos pela duração, do menor para o maior
      ordenarPorDuracao(fila);

      while (fila.length > 0) {
        let processo = fila.shift();

        while (processo.duracao > 0) {
          processo.duracao -= 1
          linhaDoTempo.push(processo)
        }
      }

    }

    // Cada processo terá uma prioridade associada e que o processo de maior prioridade deve ser executado primeiro. 
    // Se um novo processo de maior prioridade chega enquanto um processo está sendo executado, 
    // o processo atual deve ser preemptado e o novo processo deve começar a ser executado.

    function prioridadePreemptiva() {
      let tempo = 0;
      let log = '';
      let fila = [...processos];

      // Ordena os processos pela prioridade, do menor para o maior (maior prioridade)
      ordenarPorPrioridade(fila);

      console.log(`ioBound: ${fila.filter(p => p.ioBound).length} - todas: ${fila.length}`)

      while (fila.length > 0 || fila.filter(p => p.ioBound).length < fila.length) {
        let processo = fila.shift();

        processo.duracao -= 1
        linhaDoTempo.push(processo)

        if (processo.duracao > 0 || processo.ioBound) fila.push(processo)

        // gerarEventoIO(fila)
        // Reordenar a fila pela prioridade após cada execução para simular preempção
        ordenarPorPrioridade(fila);
      }

    }

    function gerarEventoIO(processos) {

      chanceGerarEvento = Math.floor(Math.random() * 10)

      console.log(`Gerando interrupção no tempo ${linhaDoTempo.length + 1}`)

      if (chanceGerarEvento == 1) {
        for (processo of processos) {
          if (processo.ioBound) {
            processo.prioridade = 0
            processo.duracao += 1
          }
        }
      }
    }

  </script>
</body>
<br>
<div>
  <br>
  <br>
  <br>
  <footer class="rodape">Desenvolvido por: Alani Rigotti de Oliveira, Luana Schmidt e Mateus Maas.</footer>

</div>

</html>